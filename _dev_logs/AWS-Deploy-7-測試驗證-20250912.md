# AWS-Deploy 步驟 7：測試驗證

## 具體操作指令
驗證 BESshow 應用程式在 EC2 上的功能正常運作

## 輸入參數與說明
- 修正 ALLOWED_HOSTS 設定問題
- 測試應用程式基本功能
- 驗證資料庫連線
- 檢查容器日誌

## 輸出結果與說明
- BESshow 應用程式在 EC2 上成功運行
- 網站功能測試全部通過：首頁、關於我們頁面
- 資料庫連線正常，所有表格已建立
- 中文內容顯示正常，編碼無問題
- 下一步：可以進行 RDS 遷移規劃

📝 **測試結果記錄**：
- 網站地址：http://43.198.12.223:8000
- 首頁測試：✅ 成功
- 關於我們頁面：✅ 成功
- 資料庫連線：✅ 成功
- 容器狀態：✅ 全部運行正常

## 執行步驟

### 7.1 修正 ALLOWED_HOSTS 設定
```bash
$ ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "cd /home/ubuntu/besshow && cat .env.staging"
# 發現環境變數名稱不匹配

$ grep ALLOWED_HOSTS django_project/settings.py
ALLOWED_HOSTS = os.getenv("DJANGO_ALLOWED_HOSTS", "127.0.0.1,localhost").split(",")

$ sed -i 's/ALLOWED_HOSTS=/DJANGO_ALLOWED_HOSTS=/' .env.staging
$ sed -i 's/ALLOWED_HOSTS=/DJANGO_ALLOWED_HOSTS=/' docker-compose.staging.yml
```
✅ ALLOWED_HOSTS 設定修正成功
- 環境變數名稱從 ALLOWED_HOSTS 修正為 DJANGO_ALLOWED_HOSTS
- Docker Compose 配置也已同步更新

### 7.2 重新部署應用程式
```bash
$ export $(cat .env.staging | xargs) && docker compose -f docker-compose.staging.yml down && docker compose -f docker-compose.staging.yml up -d
# 容器重新建置並啟動
```
✅ 應用程式重新部署成功
- 容器已重新建置並啟動
- 環境變數正確載入

### 7.3 功能測試驗證
```bash
$ curl -s http://43.198.12.223:8000 | grep -i "title\|besshow\|\u5edf\u5b87"
  <title>首頁</title>
      <a class="navbar-brand" href="/">BESshow</a>
            <h1 class="display-4 fw-bold lh-1 text-body-emphasis">BESshow 廟宇祈福網站</h1>

$ curl -s http://43.198.12.223:8000/about/ | grep -i "title"
  <title>關於我們</title>
                    <h5 class="card-title fw-bold">多種祈福燈種</h5>
```
✅ 網站功能測試成功
- 首頁正常顯示 BESshow 廟宇祈福網站
- 關於我們頁面正常載入
- 中文內容顯示正常

### 7.4 容器狀態檢查
```bash
$ docker compose -f docker-compose.staging.yml ps
NAME                IMAGE             COMMAND                  SERVICE   CREATED              STATUS              PORTS
besshow-bes-app-1   besshow-bes-app   "python manage.py ru…"   bes-app   About a minute ago   Up About a minute   0.0.0.0:8000->8000/tcp
besshow-bes-rds-1   postgres:16       "docker-entrypoint.s…"   bes-rds   About a minute ago   Up About a minute   5432/tcp
```
✅ 所有容器運行正常
- bes-app 容器：運行中，端口 8000 已開放
- bes-rds 容器：運行中，資料庫服務正常