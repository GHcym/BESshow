# BESshow 網站功能設計文件 (bes-spec-001.md)

## 1. 專案背景與目標

- **專案名稱**: BESshow (廟宇祈福網站)
- **專案目的**: 以最簡易、快速的方式，開發一個現代化且功能完整的「廟宇網站」。
- **開發策略**: 採用 MVP（最小可行產品）優先的敏捷開發模式，追求「分階段可展示」的成果。
- **主要目標**: 開發一個名為 "besshow" 的廟宇網站，讓信眾可以線上點燈並完成付款，資料可以同步到由 API 串接的燈牆進行顯示與更新。
- **專案基底**: 專案是基於 `https://github.com/wsvincent/lithium.git` 這個 Django 專案範本進行客製化開發。
- **執行方針**:
    - 以 `wsvincent/lithium` 為基礎，為廟宇快速打造一個 MVP 網站。
    - 以簡潔、穩定為核心想法，逐步完成網站功能，並設計可展示的階段功能。
    - 設計切分階段，設計成可交由 AI 輔助執行的步驟，切分階段的重點原則：功能的相依性。請由基礎模組開始建置，以方便進行測試。
    - 開發前，先檢查與修正開發環境，並完成開發環境說明文件。
    - 如果符合功能相依原則，先專注於核心功能「線上點燈」，讓信眾選擇燈種（背景或主動註冊）、並完成線上付款。

## 2. 技術與開發環境

- **程式語言**: Python
- **IDE**: VS Code + WSL 擴充套件
- **Web framework**: Django
- **DB**: PostgreSQL
- **OS**: WSL 2 - Ubuntu 24.04 LTS (in Window 11 Pro)
- **開發環境用 Docker 管理**: 使用現代化的 docker compose V2 指令與語法。
    - 分二個 Docker: `bes-web` (Django) 和 `bes-db` (PostgreSQL)。
    - 採用多容器分離架構，初期為 `bes-web` (Django) 和 `bes-db` (PostgreSQL)，後期為部署準備會加入 `nginx`。
    - `docker-compose.yml` 檔案遵循最新的 **Compose Specification**，**不包含**頂層的 `version` 屬性。
    - docker 的 `uv.lock` 是用 `pyproject.toml`，如有需要再轉 `requirements.txt`。
- **Python 套件管理**: 在 WSL 環境中使用 `uv`。
- **環境變數管理**:
    - 專案已整合並使用 `django-environ` 套件。
    - 所有敏感資訊與環境相關設定都存放在 `.env` 檔案中，該檔案已被加入 `.gitignore`。
- **AI 輔助工具**: GitHub Copilot（Gemini、ChatGPT、DeepSeek 或類似工具）。

## 3. 運維環境 (MVP 完成後處理)

- **上線部署**: 使用 AWS 服務（AWS EC2、AWS RDS...等）。
- **AWS 上的 Docker 容器職責分離**:
    - `docker-compose.yml` 中，規劃三個服務容器：
        - `nginx`: 作為反向代理（Reverse Proxy），處理靜態檔案、負載平衡，並將請求轉發給 Gunicorn。
        - `web`: 運行 Gunicorn 跟 Django 應用。
        - `db`: PostgreSQL 服務。
- **備註**: 採用多容器分離架構，初期為 `web` (Django) 和 `db` (PostgreSQL)，後期為部署準備會加入 `nginx`。

## 4. 網站功能需求

### 4.1. 需求 1：使用者線上點燈

**使用者故事**:
作為使用者（善男：男性、信女：女性、善信：善男信女統稱或二元性別），我希望能夠於網站上完成線上點燈。流程如下:
- 網站提示善信輸入資料並檢核完善。
- 網站系統自動註冊其帳號並登入。
- 查詢並顯示可選擇之燈種（光明等、財神燈...等）。
- 完成燈種與數量選擇（購物車）。
- 依顯示的金額掃描 QR Code 進行付款。
- 網站系統顯示結緣清單（訂單），並提供感謝狀（購買收據），格式可為 PDF。

**網站功能**:

- **功能名稱**: 線上點燈 (含自動註冊流程)
- **使用者**: 善信
- **優先級**: 高
- **儲存資料 (擴充)**: 姓名、性別（善男、信女、善信）、國曆生日（年月日 + 時分）、農曆生日（年月日 + 是否閏月 + 時辰地支）、手機（電話）、eMail、地址（縣市、鄉鎮區、郵遞區號、詳細地址）。

**使用者註冊資料包含**:
- **姓名**: (必填) 長度限制50。
- **性別**: (必填) 列舉清單，男性稱為善男，女性稱為信女，預設為善信（表示性別未選擇或非二元性別者）。
- **國曆生日**:
    - 年、月、日: (必填) 以日曆與下拉方式選擇。
    - 時、分: 分別以下拉方式選擇，預設為空白。
- **農曆生日**:
    - 年、月、日: 以日曆與下拉方式選擇。
    - 時辰: 子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥，預設為吉時（未選擇）。
    - 網頁提供由國曆轉換為農曆的功能，如國曆的時、分未選擇，則代入吉時。
- **手機**: (必填) 台灣手機號碼格式檢核（保留擴充格式：國際碼 + 手機號）。
- **eMail**: 格式檢查（未來擴充，可用 eMail 認證，或變更密碼...等）。
- **地址**: 國內地址以下拉選單選擇加填寫詳細地址欄，國外地址直接填寫詳細地址欄。

**功能開發的建議技術**:

- **使用者註冊與登入**: Django 的 User 模型 + `django-allauth` 或自訂表單 (支援自動註冊與登入流程，擴充性高)。
- **表單資料輸入與檢核**: Django Form / ModelForm (可設定欄位驗證、預設值、下拉選單)。
- **國曆與農曆轉換**: 使用 `lunarcalendar` 或 `tw_lunar_converter` 套件 (可將國曆轉換為農曆，並處理時辰選擇)。
- **地址下拉選單**: 使用政府 API 或 JSON 資料（如 TGOS 或 data.gov.tw，或 `https://github.com/donma/TaiwanAddressCityAreaRoadChineseEnglishJSON`）(提供台灣地址選單，支援縣市、鄉鎮等)。
- **燈種選擇與購物車**: 使用 Django 的 Session 或 `django-carton` (管理購物車與燈種數量選擇)。
- **QR Code 付款**: 產生 QR Code（未來可擴充使用第三方金流，如：Line Pay）(可用 `qrcode` 套件產生付款碼)。
- **訂單與感謝狀 PDF**: 使用 `WeasyPrint` 或 `xhtml2pdf` (將訂單轉為 PDF 格式並提供下載)。

**身份驗證模型設計**:
- **id**: Django 自動遞增整數，作為內部主鍵。
- **uuid**: CustomUser 模型中新增唯一欄位，作為 API 對外識別碼，避免 id 被猜測或枚舉。
- **email / phone_number**: 作為登入憑證，非主鍵。
- **登入邏輯**: 判斷輸入為 email 或 phone_number，再執行登入。

### 4.2. 開發階段 090301：燈種資料維護功能

- **目標**: 建立燈種資料維護功能。
- **目的**: 開發一個廟宇點燈的燈種資料維護功能。提供基本的 CRUD 功能。
- **功能簡述**: 燈種的資料 CRUD。
- **功能說明**: 先以清單式列出所有燈種、清單提供點擊或連結開啓詳細資料視窗，點擊詳細資料視窗後，可列出燈種的圖片、種類與價格。
- **資料欄位**: 燈種ID、燈種名稱、價格、燈種圖片、是否可用(True or False)。
- **進度**: 已完成最基本的 CRUD 功能。現階段功能OK。

### 4.3. 開發階段 090302：信眾個人資料維護功能

- **目標**: 建立信眾個人資料維護功能。
- **目的**: 提供信眾友善的介面，讓其能自行管理個人資料（如姓名、性別、生日、聯絡方式、地址等），而非僅依賴後台管理員操作。系統管理員帳號的維護仍透過 Django Admin 進行。
- **功能簡述**: 提供信眾自行檢視、編輯及更新其個人帳號資料的介面。
- **功能說明**:
    - 新增個人資料(Create)：信眾在註冊時，可透過信箱、手機號碼、姓名等個人資料進行註冊。
    - 檢視個人資料 (Read)：信眾登入後，可透過專屬頁面查看其在系統中儲存的個人資訊，包含姓名、電子郵件、手機號碼、性別、生日（國曆/農曆）、地址等。
    - 編輯個人資料 (Update)：信眾可修改除帳號憑證（如電子郵件，此部分仍由 `django-allauth` 流程處理）外的其他個人資料，例如姓名、手機號碼、性別、生日、地址等。
    - 資料驗證：確保使用者輸入的資料符合預期格式和業務邏輯。
    - 安全性考量：敏感操作（如密碼變更）應導向 `django-allauth` 提供的安全流程。
    - 技術實作：參考 `products` 應用程式的 CRUD 模式，建立獨立的視圖 (View)、表單 (Form) 和模板 (Template) 來處理 CustomUser 模型的資料。
- **進度**: 已可以單純的使用者建立、儲存，並可以於儲存時將國曆轉換成農曆。地址的縣市、鄉鎮市區使用下拉選取並可正確的儲存。現階段功能OK。

### 4.4. 開發階段 090303：使用者點燈流程（選擇燈種、數量進購物車，並結賬）

- **目標**: 建立使用者點燈流程（選擇燈種、數量進購物車，並結賬）。
- **功能說明**:
    0. 使用者直接執行點燈。
    1. 列出所有燈種，提供燈種的種類與價格。
    2. 以燈種清單提供選擇，選擇或加入後可修改（包含數量），提供 祈福(結緣)清單維護 即類似商品購物車功能。
    3. 購物車結帳：
        a. 流程功能重點：結帳前，檢查善信（使用者）是否登入。
        - 已登入：開啓 詳細會員資料頁面 ，顯示善信個人資料，讓善信編輯、修改與確認存檔。
        - 未登入：開啓 帳號登入（帳號建立）頁面。依選擇，如進行登入，依輸入的 email 或 電話進行比對登入。登入後顯示善信個人資料，讓善信編輯、修改與確認存檔。如選擇帳號建立，顯示帳號建立頁面，讓善信輸入與編輯個人資料，完成後確認存檔。
        a. 流程功能頁面由 **開發階段 090302** 實作，此處使用參數（如：uuid）連結操作。
        - 善信（會員）資料完善後代入至結帳功能流程：顯示購物車清單、顯示結帳金額。
    4. 依顯示的金額掃描 QR Code 進行付款。**功能建立階段先提供顯示 QR Code 圖片**。
    5. 網站系統顯示 祈福(結緣)清單（訂單），並提供感謝狀（購買收據），格式可為 PDF。
    6. BONUS: 考慮加入使用者的個人資料管理功能。
- **進度**: 已開始建置，並已完成燈種列表顯示、加入祈福清單（購物車）功能、祈福清單（購物車）詳情頁、結帳流程串接、付款頁面。

## 5. 開發日誌摘要

### 5.1. 選購流程優化 (Plan-005-選購流程優化-OK.md)

- **問題**: 使用者每將一個商品加入購物車，就會被立刻帶到購物車頁面，這打斷了使用者的購物流程，使其難以一次選購多種商品。
- **解決方案**:
    1.  修改後端重導向邏輯 (`cart/views.py`)，將 `add_to_cart` 視圖的重導向目標改為商品列表頁。
    2.  建立全域內容處理器 (`cart/context_processors.py`)，將購物車物件注入到所有頁面的模板渲染內容中。
    3.  實作前端迷你購物車 (`templates/_base.html`)，在導覽列中顯示購物車內容。
- **成果**: 成功優化了商品的選購流程，提升了使用者體驗的流暢度。

### 5.2. 開發階段 090303 檢查 (Plan-開發階段-090303-Check-OK.md)

- **檢查結論**: 專案架構清晰，模組劃分合理。`開發階段-090302` 的信眾資料維護功能已完整實作，包含農曆轉換、地址連動等關鍵需求。`accounts` 應用中的 `UserProfileUpdateView` 已為 `開發階段-090303` 的結帳流程準備了必要的掛鉤 (`next=payment`)。
- **成果**: 成功地驗證了專案的當前狀態，確認了 `開發階段-090302` 的完成度，並為 `開發階段-090303` 的順利啟動掃清了障礙。

### 5.3. 開發階段 090303 完成 (Plan-開發階段-090303-OK.md)

- **目標**: 建立完整的使用者點燈流程，從選擇燈種、加入祈福清單（購物車），到最終結帳。
- **完成成果**:
    - **燈種列表**: 使用者現在可以在燈種列表頁面為每個燈種指定欲購買的數量。
    - **購物車功能**: 「加入祈福清單」功能現在會正確處理使用者指定的數量，且僅限已登入的使用者操作。
    - **結帳流程**: 已將「購物車詳情頁」的結帳按鈕，與「使用者資料確認」頁面 (`my-account/profile/edit/`) 正確串接，並透過 `?next=payment` 參數，確保使用者在完成資料填寫後，會被無縫導向至最終的付款頁面。
    - **付款與訂單**: 確認了 `orders` 應用中已包含完整的付款頁面、訂單建立邏輯，以及訂單確認頁面。
- **總結**: 成功地將專案中已有的各個功能模組串接成一個連貫的「使用者點燈流程」。

### 5.4. 除錯：結帳與訂單 (Plan-除錯-結帳與訂單-A-OK.md)

- **問題根本原因**:
    1.  `accounts/forms.py` 中的 `CustomUserUpdateForm` 未包含 `last_name` (姓氏) 欄位。
    2.  `orders/views.py` 中的 `payment_page` 視圖在載入前會檢查使用者資料的完整性，由於 `last_name` 始終為空，導致無限重導向循環。
    3.  模板錯誤訊息屏蔽，增加了早期排查的難度。
- **解決方案**:
    1.  強化日誌，明確指出哪個欄位缺失。
    2.  在 `CustomUserUpdateForm` 中補回 `last_name` 欄位。
    3.  修正 `user_profile_form.html`，確保錯誤訊息可以被正確渲染。
    4.  導入 `reverse`。
- **成果**: 成功修復了使用者在結帳時因個人資料不完整而陷入無限重導向循環的問題。

### 5.5. 除錯：確認付款並建立訂單 (Plan-除錯-訂單與結帳-A-OK.md)

- **問題分析**:
    1.  `orders/views.py` 中的 `create_order` 視圖缺乏資料庫交易，可能導致資料不一致。
    2.  錯誤處理不足，未處理使用者在沒有購物車的情況下嘗試建立訂單的邊界情況。
- **完成成果**:
    - 透過引入 `django.db.transaction.atomic`，提升了資料一致性。
    - 增強了程式健壯性，加入了對購物車是否存在、是否為空的檢查。
    - 改善了可追蹤性，在關鍵執行路徑中加入了詳細的日誌記錄。
- **總結**: 遵循軟體工程的最佳實踐，對核心交易功能進行了一次重要的重構與加固。
