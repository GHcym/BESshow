# BESshow AWS 部署方案建議實施計劃

**文件版本：** v1.0  
**建立日期：** 2025-01-11  
**專案名稱：** BESshow 廟宇祈福網站  

## 專案概述

BESshow 是一個基於 Django + PostgreSQL 的廟宇祈福網站，主要功能包含線上點燈、訂單管理、用戶系統等。本計劃旨在提供階段性的 AWS 部署方案，最大化利用免費額度並確保成本可控。

## 階段性部署策略

### 第一階段：本地開發環境（目前）

**目標：** 功能開發與測試  
**成本：** 免費  
**期間：** 開發階段  

**配置：**
```yaml
# docker-compose.dev.yml
services:
  bes-app:
    build: .
    command: tail -f /dev/null
    volumes:
      - .:/app  # 開發時使用 volume mount
    ports:
      - "8000:8000"
    environment:
      - DEBUG=True
      - DATABASE_URL=postgresql://besshow:password@bes-db:5432/besshow
    depends_on:
      - bes-db

  bes-db:
    image: postgres:16
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=besshow
      - POSTGRES_USER=besshow
      - POSTGRES_PASSWORD=dev_password
      - POSTGRES_HOST_AUTH_METHOD=trust

volumes:
  postgres_data:
```

### 第二階段：AWS EC2 測試部署

**目標：** 雲端環境測試與驗證  
**成本：** 利用免費額度  
**期間：** 功能完整後  

#### AWS 資源配置

**EC2 實例：**
- 類型：t3.micro（免費額度 750小時/月）
- 作業系統：Ubuntu 22.04 LTS
- 儲存：30GB EBS gp3（免費額度）
- 安全群組：HTTP(80), HTTPS(443), SSH(22)

**EBS Volume：**
- 大小：20GB（資料庫資料）
- 類型：gp3
- 掛載點：/opt/besshow/data

#### 部署配置

**docker-compose.staging.yml：**
```yaml
services:
  bes-app:
    build: .
    restart: unless-stopped
    environment:
      - DEBUG=False
      - DATABASE_URL=postgresql://besshow:${DB_PASSWORD}@bes-db:5432/besshow
      - ALLOWED_HOSTS=your-domain.com,your-ec2-ip
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      - bes-db
    networks:
      - besshow-network

  bes-db:
    image: postgres:16
    restart: unless-stopped
    volumes:
      - /opt/besshow/data:/var/lib/postgresql/data
      - /opt/besshow/backups:/backups
    environment:
      - POSTGRES_DB=besshow
      - POSTGRES_USER=besshow
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    networks:
      - besshow-network

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - /var/log/nginx:/var/log/nginx
    depends_on:
      - bes-app
    networks:
      - besshow-network

networks:
  besshow-network:
    driver: bridge
```

**Nginx 配置 (nginx/nginx.conf)：**
```nginx
events {
    worker_connections 1024;
}

http {
    upstream bes_app {
        server bes-app:8000;
    }

    server {
        listen 80;
        server_name your-domain.com;
        
        location / {
            proxy_pass http://bes_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /static/ {
            alias /app/staticfiles/;
        }

        location /media/ {
            alias /app/media/;
        }
    }
}
```

**環境變數檔案 (.env.staging)：**
```bash
# 資料庫設定
DB_PASSWORD=your_secure_db_password

# Django 設定
SECRET_KEY=your_very_long_secret_key_here
DEBUG=False
ALLOWED_HOSTS=your-domain.com,your-ec2-ip

# 備份設定
BACKUP_S3_BUCKET=besshow-backups
AWS_REGION=ap-northeast-1
```

#### 部署腳本

**deploy.sh：**
```bash
#!/bin/bash
set -e

echo "=== BESshow 部署腳本 ==="

# 更新系統
sudo apt update && sudo apt upgrade -y

# 安裝 Docker
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    sudo usermod -aG docker $USER
fi

# 安裝 Docker Compose
if ! command -v docker-compose &> /dev/null; then
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# 建立目錄結構
sudo mkdir -p /opt/besshow/{data,backups,logs}
sudo chown -R $USER:$USER /opt/besshow

# 部署應用程式
docker-compose -f docker-compose.staging.yml down
docker-compose -f docker-compose.staging.yml up --build -d

# 執行資料庫遷移
docker-compose -f docker-compose.staging.yml exec bes-app python manage.py migrate

# 收集靜態檔案
docker-compose -f docker-compose.staging.yml exec bes-app python manage.py collectstatic --noinput

echo "=== 部署完成 ==="
```

**備份腳本 (backup.sh)：**
```bash
#!/bin/bash
set -e

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="besshow_backup_${BACKUP_DATE}.sql.gz"

# 資料庫備份
docker-compose -f docker-compose.staging.yml exec bes-db pg_dump -U besshow besshow | gzip > /opt/besshow/backups/${BACKUP_FILE}

# 上傳到 S3（如果設定了）
if [ ! -z "$BACKUP_S3_BUCKET" ]; then
    aws s3 cp /opt/besshow/backups/${BACKUP_FILE} s3://${BACKUP_S3_BUCKET}/database/
fi

# 保留最近 7 天的備份
find /opt/besshow/backups -name "besshow_backup_*.sql.gz" -mtime +7 -delete

echo "備份完成: ${BACKUP_FILE}"
```

### 第三階段：生產環境部署

**目標：** 正式上線服務  
**成本：** 根據實際使用量付費  
**期間：** 有實際用戶流量後  

#### 升級項目

**資料庫：**
- 升級至 AWS RDS PostgreSQL
- 啟用自動備份和多可用區部署
- 設定讀取副本（如需要）

**儲存：**
- 媒體檔案遷移至 S3
- 設定 CloudFront CDN

**監控：**
- AWS CloudWatch 監控
- 設定告警通知

**安全性：**
- AWS Certificate Manager SSL 憑證
- WAF 防護
- VPC 網路隔離

## 成本分析

### 免費額度使用

**EC2：**
- t3.micro：750 小時/月（約 31 天 24/7）
- 成本：$0

**EBS：**
- 30GB gp3：免費額度內
- 成本：$0

**資料傳輸：**
- 15GB 出站流量/月
- 成本：$0

**S3（備份）：**
- 5GB 儲存空間
- 成本：$0

### 預估月費用（超出免費額度後）

**第二階段：**
- EC2 t3.micro：~$8.5/月
- EBS 額外儲存：~$2/月
- 總計：~$10.5/月

**第三階段：**
- RDS db.t3.micro：~$15/月
- S3 + CloudFront：~$5/月
- 其他服務：~$10/月
- 總計：~$40/月

## 監控與維護

### 免費額度監控

**設定 Billing Alerts：**
```bash
# 使用 AWS CLI 設定帳單告警
aws budgets create-budget --account-id YOUR_ACCOUNT_ID --budget '{
  "BudgetName": "BESshow-Monthly-Budget",
  "BudgetLimit": {
    "Amount": "10",
    "Unit": "USD"
  },
  "TimeUnit": "MONTHLY",
  "BudgetType": "COST"
}'
```

### 自動化維護

**Crontab 設定：**
```bash
# 每日備份
0 2 * * * /opt/besshow/backup.sh

# 每週清理日誌
0 3 * * 0 find /var/log -name "*.log" -mtime +7 -delete

# 每月重啟服務（避免記憶體洩漏）
0 4 1 * * docker-compose -f /opt/besshow/docker-compose.staging.yml restart
```

## 實施時程

### 第一階段（目前 - 2週）
- [x] 本地開發環境建立
- [x] 基本功能開發
- [ ] 功能測試完成

### 第二階段（2-4週）
- [ ] AWS 帳號設定
- [ ] EC2 實例建立
- [ ] 部署腳本準備
- [ ] 測試環境部署
- [ ] 功能驗證

### 第三階段（視需求）
- [ ] 域名註冊
- [ ] SSL 憑證設定
- [ ] RDS 遷移
- [ ] 效能優化
- [ ] 監控告警設定

## 風險評估與應對

### 技術風險
- **Docker 容器問題**：準備回滾腳本
- **資料庫損壞**：定期備份與測試還原
- **網路連線問題**：設定健康檢查

### 成本風險
- **超出免費額度**：設定帳單告警
- **流量突增**：設定自動擴展限制
- **儲存空間不足**：監控磁碟使用量

### 安全風險
- **未授權存取**：設定防火牆規則
- **資料外洩**：加密敏感資料
- **DDoS 攻擊**：使用 CloudFlare 防護

## 結論

本計劃提供了階段性的 AWS 部署策略，能夠：

1. **最大化免費額度使用**：第二階段可完全在免費額度內運行
2. **成本可控**：每個階段都有明確的成本預估
3. **彈性擴展**：可根據實際需求逐步升級
4. **風險可控**：完整的備份和監控機制

建議先完成第一階段的功能開發，再進行第二階段的雲端部署測試。