# 除錯計畫：確認付款並建立訂單

## 1. 任務範疇 (Task Scope)

對「確認付款並建立訂單」功能進行除錯。此功能由 `orders` 應用的 `create_order` 視圖處理。

## 2. 除錯策略 (Method)

1.  **程式碼審查**:
    *   重點審查 `orders/views.py` 中的 `create_order` 視圖邏輯。
    *   檢查 `orders/models.py` 中的 `Order` 與 `OrderItem` 模型，確認是否存在任何可能導致錯誤的約束或自訂 `save` 方法。

2.  **識別潛在問題點**:
    *   **資料不一致**: `create_order` 視圖中執行了多個資料庫寫入操作（建立 Order、建立 OrderItem、刪除 CartItem、刪除 Cart）。如果中途發生錯誤，可能導致資料狀態不一致。
    *   **使用者資料不完整**: 建立訂單時，程式碼直接從 `request.user` 物件獲取姓名、地址等資訊。如果這些資料為空，可能會建立出不完整的訂單記錄。
    *   **購物車不存在**: `Cart.objects.get(user=request.user)` 在特定邊界情況下可能引發 `DoesNotExist` 錯誤。

3.  **解決方案與驗證**:
    *   **引入資料庫交易 (Transaction)**: 為了確保資料一致性，將使用 `django.db.transaction.atomic` 來包裹 `create_order` 視圖中的所有資料庫操作。這將確保所有操作要麼全部成功，要麼在發生錯誤時全部回滾。
    *   **增加日誌紀錄 (Logging)**: 在 `create_order` 視圖的關鍵步驟（如開始執行、訂單建立前後、購物車清除後）加入詳細的日誌輸出。這將有助於追蹤執行流程，並在問題復現時提供線索。
    *   **引導測試**: 在應用上述修改後，將引導使用者重現操作，並藉由觀察日誌來確認問題是否解決或找到新的錯誤點。

## 3. 預期成果 (Expected Outcome)

- 透過引入資料庫交易，提升訂單建立過程的穩定性與資料一致性。
- 透過增加日誌，為未來可能的除錯提供更多線索。
- 最終解決「確認付款並建立訂單」功能中潛在的錯誤。
