# AWS EC2 部署執行計劃

**執行日期：** 2025-01-11  
**目標：** 第二階段 AWS EC2 測試部署  

## 執行檢查清單

### 階段 1：AWS 帳號設定 (30分鐘)
- [ ] 1.1 登入 AWS Console
- [ ] 1.2 設定 Billing Alerts (預算 $10)
- [ ] 1.3 建立 IAM 用戶 (可選)
- [ ] 1.4 選擇部署區域 (建議 ap-northeast-1 東京)

### 階段 2：EC2 實例建立 (45分鐘)
- [ ] 2.1 啟動 EC2 實例
  - 類型：t3.micro
  - AMI：Ubuntu 22.04 LTS
  - 儲存：30GB gp3
- [ ] 2.2 設定安全群組
  - SSH (22): 您的 IP
  - HTTP (80): 0.0.0.0/0
  - HTTPS (443): 0.0.0.0/0
  - Custom (8000): 0.0.0.0/0 (測試用)
- [ ] 2.3 建立或選擇 Key Pair
- [ ] 2.4 記錄公開 IP 位址

### 階段 3：伺服器環境設定 (30分鐘)
- [ ] 3.1 SSH 連線到 EC2
- [ ] 3.2 更新系統套件
- [ ] 3.3 安裝 Docker 和 Docker Compose
- [ ] 3.4 建立應用程式目錄結構

### 階段 4：應用程式部署 (45分鐘)
- [ ] 4.1 上傳程式碼到 EC2
- [ ] 4.2 建立環境變數檔案
- [ ] 4.3 執行 Docker 建構和部署
- [ ] 4.4 執行資料庫遷移
- [ ] 4.5 建立管理員帳號

### 階段 5：測試驗證 (30分鐘)
- [ ] 5.1 訪問網站首頁
- [ ] 5.2 測試用戶註冊/登入
- [ ] 5.3 測試歷史訂單功能
- [ ] 5.4 測試管理後台
- [ ] 5.5 設定自動備份

## 詳細執行指令

### 1. AWS Console 設定

**Billing Alert 設定：**
1. 進入 AWS Console > Billing > Budgets
2. Create Budget > Cost Budget
3. 設定預算金額：$10 USD
4. 設定告警：80% 和 100%

### 2. EC2 實例啟動

**啟動參數：**
```
Instance Type: t3.micro
AMI: Ubuntu Server 22.04 LTS (HVM)
Storage: 30 GiB gp3
Security Group: 
  - SSH (22) from My IP
  - HTTP (80) from Anywhere
  - HTTPS (443) from Anywhere  
  - Custom TCP (8000) from Anywhere
```

### 3. 伺服器初始化腳本

```bash
#!/bin/bash
# 在 EC2 上執行的初始化腳本

# 更新系統
sudo apt update && sudo apt upgrade -y

# 安裝必要工具
sudo apt install -y curl wget git unzip

# 安裝 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker ubuntu

# 安裝 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 建立應用程式目錄
sudo mkdir -p /opt/besshow/{data,backups,logs}
sudo chown -R ubuntu:ubuntu /opt/besshow

# 重新登入以套用 docker 群組
echo "請重新登入以套用 Docker 群組權限"
```

### 4. 程式碼部署

**方法一：Git Clone (推薦)**
```bash
# 在 EC2 上執行
cd /opt/besshow
git clone https://github.com/your-username/besshow.git .
```

**方法二：SCP 上傳**
```bash
# 在本地執行
scp -i your-key.pem -r besshow/ ubuntu@your-ec2-ip:/opt/besshow/
```

### 5. 環境變數設定

```bash
# 在 EC2 上建立 .env.staging
cat > /opt/besshow/.env.staging << EOF
DB_PASSWORD=BesShow2025SecurePassword
SECRET_KEY=$(python3 -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')
DEBUG=False
ALLOWED_HOSTS=your-ec2-ip,your-domain.com
EOF
```

### 6. 部署執行

```bash
# 在 EC2 上執行
cd /opt/besshow
docker-compose -f docker-compose.prod.yml --env-file .env.staging up --build -d

# 等待服務啟動
sleep 30

# 執行資料庫遷移
docker-compose -f docker-compose.prod.yml exec bes-app python manage.py migrate

# 建立管理員帳號
docker-compose -f docker-compose.prod.yml exec bes-app python manage.py createsuperuser

# 收集靜態檔案
docker-compose -f docker-compose.prod.yml exec bes-app python manage.py collectstatic --noinput
```

## 測試檢查項目

### 功能測試
- [ ] 首頁載入正常
- [ ] 用戶註冊功能
- [ ] 用戶登入功能
- [ ] 產品瀏覽功能
- [ ] 購物車功能
- [ ] 訂單建立功能
- [ ] 歷史訂單查詢功能
- [ ] 管理後台存取

### 效能測試
- [ ] 頁面載入時間 < 3秒
- [ ] 資料庫查詢回應正常
- [ ] 靜態檔案載入正常

### 安全測試
- [ ] HTTPS 重定向 (如已設定)
- [ ] 管理後台權限控制
- [ ] 資料庫連線安全

## 監控設定

### 基本監控
```bash
# 設定系統監控腳本
cat > /opt/besshow/monitor.sh << 'EOF'
#!/bin/bash
# 基本系統監控

echo "=== 系統狀態 $(date) ==="
echo "磁碟使用量:"
df -h
echo ""
echo "記憶體使用量:"
free -h
echo ""
echo "Docker 容器狀態:"
docker ps
echo ""
echo "應用程式日誌 (最後10行):"
docker-compose -f docker-compose.prod.yml logs --tail=10 bes-app
EOF

chmod +x /opt/besshow/monitor.sh
```

### 自動備份設定
```bash
# 設定每日備份
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/besshow/backup.sh") | crontab -
```

## 預期結果

**成功指標：**
- EC2 實例正常運行
- 網站可透過公開 IP 存取
- 所有核心功能正常運作
- 資料庫資料持久化
- 免費額度使用量在控制範圍內

**存取資訊：**
- 網站：http://your-ec2-ip:8000
- 管理後台：http://your-ec2-ip:8000/admin/
- SSH：ssh -i your-key.pem ubuntu@your-ec2-ip

## 故障排除

### 常見問題
1. **Docker 權限問題**：重新登入或使用 `sudo`
2. **連接埠無法存取**：檢查安全群組設定
3. **容器啟動失敗**：檢查 `docker-compose logs`
4. **資料庫連線失敗**：檢查環境變數設定

### 回滾計劃
```bash
# 如果部署失敗，停止所有服務
docker-compose -f docker-compose.prod.yml down

# 檢查日誌
docker-compose -f docker-compose.prod.yml logs

# 重新部署
docker-compose -f docker-compose.prod.yml up --build -d
```

## 下一步計劃

部署成功後：
1. 設定域名 (可選)
2. 設定 SSL 憑證
3. 效能優化
4. 監控告警設定
5. 備份策略完善