# AWS-Deploy 步驟 5：環境部署

## 具體操作指令
在 EC2 實例上安裝 Docker 環境並啟動 BESshow 測試服務

## 輸入參數與說明
- 目標伺服器：43.198.12.223
- 安裝 Docker Engine 和 Docker Compose
- 執行測試階段部署腳本
- 啟動 bes-app 和 bes-rds 服務

## 輸出結果與說明
- Docker 環境安裝成功（版本 28.4.0）
- BESshow 應用程式已成功部署並運行
- 資料庫遷移完成，所有表格已建立
- 服務可通過 http://43.198.12.223:8000 存取
- 下一步：需要修正 ALLOWED_HOSTS 設定並進行功能測試

📝 **部署結果記錄**：
- Docker 版本：28.4.0
- Docker Compose 版本：v2.39.2
- 應用程式容器：besshow-bes-app-1 (運行中)
- 資料庫容器：besshow-bes-rds-1 (運行中)
- 網路連接埠：8000 已開放

## 執行步驟

### 5.1 更新系統套件
```bash
$ ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "sudo apt update && sudo apt upgrade -y"
# 系統套件更新成功，安裝 6 個更新套件
```
✅ 系統套件更新成功
- 更新了 Linux 核心和安全修補

### 5.2 安裝 Docker 環境
```bash
$ ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "sudo apt install -y ca-certificates curl gnupg lsb-release"
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
$ echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
$ sudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
```
✅ Docker 安裝成功
- Docker 版本：28.4.0
- Docker Compose 版本：v2.39.2

### 5.3 配置 Docker 環境
```bash
$ sudo usermod -aG docker ubuntu
$ sudo systemctl start docker && sudo systemctl enable docker
$ docker --version && docker compose version
Docker version 28.4.0, build d8eb465
Docker Compose version v2.39.2
```
✅ Docker 環境配置成功
- ubuntu 用戶已加入 docker 群組
- Docker 服務已啟動並設為開機自啟

### 5.4 執行測試階段部署
```bash
$ ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "cd /home/ubuntu/besshow && ./scripts/deploy-staging.sh"
🚀 Starting BESshow staging deployment...
📦 Stopping existing containers...
🔨 Building and starting services...
# Docker 建置過程成功
⏳ Waiting for database to be ready...
🗄️ Running database migrations...
# 資料庫遷移成功，建立所有表格
✅ Staging deployment completed!
🌐 Application available at: http://43.198.12.223:8000
```
✅ 測試階段部署成功
- Docker 容器建置成功
- 資料庫遷移完成
- 應用程式已啟動

### 5.5 驗證部署狀態
```bash
$ docker compose -f docker-compose.staging.yml ps
NAME                IMAGE             COMMAND                  SERVICE   CREATED              STATUS              PORTS
besshow-bes-app-1   besshow-bes-app   "python manage.py ru…"   bes-app   About a minute ago   Up About a minute   0.0.0.0:8000->8000/tcp
besshow-bes-rds-1   postgres:16       "docker-entrypoint.s…"   bes-rds   About a minute ago   Up About a minute   5432/tcp

$ curl -I http://43.198.12.223:8000
HTTP/1.1 400 Bad Request
```
✅ 容器運行狀態正常
- bes-app 和 bes-rds 容器都在運行
- 應用程式可以接收 HTTP 請求
⚠️ HTTP 400 錯誤可能是 ALLOWED_HOSTS 設定問題