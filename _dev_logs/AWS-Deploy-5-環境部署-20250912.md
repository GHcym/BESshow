# AWS-Deploy æ­¥é©Ÿ 5ï¼šç’°å¢ƒéƒ¨ç½²

## å…·é«”æ“ä½œæŒ‡ä»¤
åœ¨ EC2 å¯¦ä¾‹ä¸Šå®‰è£ Docker ç’°å¢ƒä¸¦å•Ÿå‹• BESshow æ¸¬è©¦æœå‹™

## è¼¸å…¥åƒæ•¸èˆ‡èªªæ˜
- ç›®æ¨™ä¼ºæœå™¨ï¼š43.198.12.223
- å®‰è£ Docker Engine å’Œ Docker Compose
- åŸ·è¡Œæ¸¬è©¦éšæ®µéƒ¨ç½²è…³æœ¬
- å•Ÿå‹• bes-app å’Œ bes-rds æœå‹™

## è¼¸å‡ºçµæœèˆ‡èªªæ˜
- Docker ç’°å¢ƒå®‰è£æˆåŠŸï¼ˆç‰ˆæœ¬ 28.4.0ï¼‰
- BESshow æ‡‰ç”¨ç¨‹å¼å·²æˆåŠŸéƒ¨ç½²ä¸¦é‹è¡Œ
- è³‡æ–™åº«é·ç§»å®Œæˆï¼Œæ‰€æœ‰è¡¨æ ¼å·²å»ºç«‹
- æœå‹™å¯é€šé http://43.198.12.223:8000 å­˜å–
- ä¸‹ä¸€æ­¥ï¼šéœ€è¦ä¿®æ­£ ALLOWED_HOSTS è¨­å®šä¸¦é€²è¡ŒåŠŸèƒ½æ¸¬è©¦

ğŸ“ **éƒ¨ç½²çµæœè¨˜éŒ„**ï¼š
- Docker ç‰ˆæœ¬ï¼š28.4.0
- Docker Compose ç‰ˆæœ¬ï¼šv2.39.2
- æ‡‰ç”¨ç¨‹å¼å®¹å™¨ï¼šbesshow-bes-app-1 (é‹è¡Œä¸­)
- è³‡æ–™åº«å®¹å™¨ï¼šbesshow-bes-rds-1 (é‹è¡Œä¸­)
- ç¶²è·¯é€£æ¥åŸ ï¼š8000 å·²é–‹æ”¾

## åŸ·è¡Œæ­¥é©Ÿ

### 5.1 æ›´æ–°ç³»çµ±å¥—ä»¶
```bash
$ ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "sudo apt update && sudo apt upgrade -y"
# ç³»çµ±å¥—ä»¶æ›´æ–°æˆåŠŸï¼Œå®‰è£ 6 å€‹æ›´æ–°å¥—ä»¶
```
âœ… ç³»çµ±å¥—ä»¶æ›´æ–°æˆåŠŸ
- æ›´æ–°äº† Linux æ ¸å¿ƒå’Œå®‰å…¨ä¿®è£œ

### 5.2 å®‰è£ Docker ç’°å¢ƒ
```bash
$ ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "sudo apt install -y ca-certificates curl gnupg lsb-release"
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
$ echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
$ sudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
```
âœ… Docker å®‰è£æˆåŠŸ
- Docker ç‰ˆæœ¬ï¼š28.4.0
- Docker Compose ç‰ˆæœ¬ï¼šv2.39.2

### 5.3 é…ç½® Docker ç’°å¢ƒ
```bash
$ sudo usermod -aG docker ubuntu
$ sudo systemctl start docker && sudo systemctl enable docker
$ docker --version && docker compose version
Docker version 28.4.0, build d8eb465
Docker Compose version v2.39.2
```
âœ… Docker ç’°å¢ƒé…ç½®æˆåŠŸ
- ubuntu ç”¨æˆ¶å·²åŠ å…¥ docker ç¾¤çµ„
- Docker æœå‹™å·²å•Ÿå‹•ä¸¦è¨­ç‚ºé–‹æ©Ÿè‡ªå•Ÿ

### 5.4 åŸ·è¡Œæ¸¬è©¦éšæ®µéƒ¨ç½²
```bash
$ ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "cd /home/ubuntu/besshow && ./scripts/deploy-staging.sh"
ğŸš€ Starting BESshow staging deployment...
ğŸ“¦ Stopping existing containers...
ğŸ”¨ Building and starting services...
# Docker å»ºç½®éç¨‹æˆåŠŸ
â³ Waiting for database to be ready...
ğŸ—„ï¸ Running database migrations...
# è³‡æ–™åº«é·ç§»æˆåŠŸï¼Œå»ºç«‹æ‰€æœ‰è¡¨æ ¼
âœ… Staging deployment completed!
ğŸŒ Application available at: http://43.198.12.223:8000
```
âœ… æ¸¬è©¦éšæ®µéƒ¨ç½²æˆåŠŸ
- Docker å®¹å™¨å»ºç½®æˆåŠŸ
- è³‡æ–™åº«é·ç§»å®Œæˆ
- æ‡‰ç”¨ç¨‹å¼å·²å•Ÿå‹•

### 5.5 é©—è­‰éƒ¨ç½²ç‹€æ…‹
```bash
$ docker compose -f docker-compose.staging.yml ps
NAME                IMAGE             COMMAND                  SERVICE   CREATED              STATUS              PORTS
besshow-bes-app-1   besshow-bes-app   "python manage.py ruâ€¦"   bes-app   About a minute ago   Up About a minute   0.0.0.0:8000->8000/tcp
besshow-bes-rds-1   postgres:16       "docker-entrypoint.sâ€¦"   bes-rds   About a minute ago   Up About a minute   5432/tcp

$ curl -I http://43.198.12.223:8000
HTTP/1.1 400 Bad Request
```
âœ… å®¹å™¨é‹è¡Œç‹€æ…‹æ­£å¸¸
- bes-app å’Œ bes-rds å®¹å™¨éƒ½åœ¨é‹è¡Œ
- æ‡‰ç”¨ç¨‹å¼å¯ä»¥æ¥æ”¶ HTTP è«‹æ±‚
âš ï¸ HTTP 400 éŒ¯èª¤å¯èƒ½æ˜¯ ALLOWED_HOSTS è¨­å®šå•é¡Œ