# BESshow 開發-測試環境同步指南

**文件版本**: v1.0  
**建立日期**: 2025-09-12  
**適用環境**: 本地開發 → AWS EC2 測試環境

## 1. 環境資訊

### 本地開發環境
- **位置**: `/home/ksu/bess/besshow/`
- **Docker Compose**: `docker-compose.yml`
- **開發模式**: DEBUG=True, 本地 PostgreSQL

### AWS 測試環境
- **EC2 實例**: i-007829cf4b3de6c5e (43.198.12.223)
- **位置**: `/home/ubuntu/besshow/`
- **Docker Compose**: `docker-compose.staging.yml`
- **測試模式**: DEBUG=True, 容器化 PostgreSQL
- **網站**: http://43.198.12.223:8000

## 2. 同步方法

### 方法 1：完整自動化同步（推薦）

#### 建立自動化腳本
```bash
# 建立同步腳本
cat > scripts/sync-to-aws.sh << 'EOF'
#!/bin/bash

echo "🔄 Starting sync to AWS staging environment..."

# 檢查必要檔案
if [ ! -f ".key/besshow-key.pem" ]; then
    echo "❌ SSH key not found: .key/besshow-key.pem"
    exit 1
fi

# 同步檔案到 EC2
echo "📁 Syncing files..."
rsync -avz --progress \
    -e "ssh -i .key/besshow-key.pem -o StrictHostKeyChecking=no" \
    --exclude='_dev_logs' \
    --exclude='__pycache__' \
    --exclude='.git' \
    --exclude='media' \
    --exclude='.venv' \
    --exclude='node_modules' \
    --exclude='.aider*' \
    ./ ubuntu@43.198.12.223:/home/ubuntu/besshow/

# 重新部署應用程式
echo "🚀 Redeploying application..."
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && ./scripts/deploy-staging.sh"

# 檢查部署狀態
echo "🔍 Checking deployment status..."
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml ps"

echo "✅ Sync completed!"
echo "🌐 Test site: http://43.198.12.223:8000"
EOF

# 設定執行權限
chmod +x scripts/sync-to-aws.sh
```

#### 使用方法
```bash
# 執行完整同步
./scripts/sync-to-aws.sh
```

### 方法 2：增量檔案同步

#### 僅同步檔案（不重新部署）
```bash
rsync -avz --progress \
    -e "ssh -i .key/besshow-key.pem" \
    --exclude='_dev_logs' \
    --exclude='__pycache__' \
    --exclude='.git' \
    --exclude='media' \
    --exclude='.venv' \
    ./ ubuntu@43.198.12.223:/home/ubuntu/besshow/
```

#### 同步特定檔案或目錄
```bash
# 同步特定檔案
rsync -avz -e "ssh -i .key/besshow-key.pem" \
    django_project/settings.py \
    ubuntu@43.198.12.223:/home/ubuntu/besshow/django_project/

# 同步特定目錄
rsync -avz -e "ssh -i .key/besshow-key.pem" \
    templates/ \
    ubuntu@43.198.12.223:/home/ubuntu/besshow/templates/
```

### 方法 3：容器重新建置

#### 重新建置並啟動容器
```bash
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml up --build -d"
```

#### 僅重啟應用程式容器
```bash
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml restart bes-app"
```

## 3. 常用操作指令

### 檢查遠端狀態
```bash
# 檢查容器狀態
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml ps"

# 檢查應用程式日誌
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml logs bes-app --tail=20"

# 檢查資料庫狀態
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml logs bes-rds --tail=10"
```

### 資料庫操作
```bash
# 執行資料庫遷移
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml exec bes-app python manage.py migrate"

# 收集靜態檔案
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml exec bes-app python manage.py collectstatic --noinput"

# 建立超級用戶
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml exec bes-app python manage.py createsuperuser"
```

### 除錯與維護
```bash
# 進入應用程式容器
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml exec bes-app bash"

# 進入資料庫容器
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml exec bes-rds psql -U besshow -d besshow"

# 清理未使用的 Docker 資源
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "docker system prune -f"
```

## 4. 建議工作流程

### 日常開發流程
1. **本地開發** → 修改程式碼並測試
2. **提交變更** → Git commit（可選）
3. **同步測試** → `./scripts/sync-to-aws.sh`
4. **驗證功能** → 訪問 http://43.198.12.223:8000
5. **確認無誤** → 繼續開發或準備發布

### 快速修復流程
1. **識別問題** → 在測試環境發現問題
2. **本地修復** → 快速修改程式碼
3. **快速同步** → 僅同步修改的檔案
4. **重啟服務** → `docker compose restart bes-app`
5. **驗證修復** → 確認問題已解決

### 重大更新流程
1. **完整測試** → 本地環境完整測試
2. **備份資料** → 備份測試環境資料庫
3. **完整同步** → `./scripts/sync-to-aws.sh`
4. **資料庫遷移** → 執行必要的 migrate
5. **功能驗證** → 完整功能測試
6. **效能檢查** → 檢查應用程式效能

## 5. 故障排除

### 常見問題與解決方案

#### SSH 連線問題
```bash
# 檢查 SSH 金鑰權限
chmod 400 .key/besshow-key.pem

# 測試 SSH 連線
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 "echo 'Connection OK'"
```

#### 容器啟動失敗
```bash
# 檢查容器日誌
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml logs"

# 強制重新建置
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml down && docker compose -f docker-compose.staging.yml up --build -d"
```

#### 資料庫連線問題
```bash
# 檢查資料庫容器狀態
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml exec bes-rds pg_isready -U besshow"

# 重啟資料庫容器
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml restart bes-rds"
```

#### 檔案權限問題
```bash
# 修正檔案權限
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "sudo chown -R ubuntu:ubuntu /home/ubuntu/besshow/"
```

## 6. 效能優化建議

### 同步效能優化
- 使用 `--exclude` 排除不必要的檔案
- 考慮使用 `--delete` 選項清理舊檔案（謹慎使用）
- 大型檔案可考慮分別處理

### 部署效能優化
- 僅在必要時重新建置 Docker 映像
- 使用 `restart` 而非 `up --build` 進行快速重啟
- 定期清理 Docker 系統資源

## 7. 安全注意事項

### SSH 金鑰管理
- 定期輪換 SSH 金鑰
- 確保私鑰檔案權限為 400
- 不要將私鑰提交到版本控制

### 環境變數安全
- 測試環境使用不同的密碼
- 避免在腳本中硬編碼敏感資訊
- 定期檢查環境變數配置

## 8. 監控與日誌

### 部署監控
```bash
# 建立監控腳本
cat > scripts/check-aws-status.sh << 'EOF'
#!/bin/bash
echo "🔍 Checking AWS staging environment status..."

# 檢查網站可用性
if curl -s -o /dev/null -w "%{http_code}" http://43.198.12.223:8000 | grep -q "200"; then
    echo "✅ Website is accessible"
else
    echo "❌ Website is not accessible"
fi

# 檢查容器狀態
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml ps"
EOF

chmod +x scripts/check-aws-status.sh
```

### 日誌收集
```bash
# 收集應用程式日誌
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml logs bes-app" > aws-app.log

# 收集資料庫日誌
ssh -i .key/besshow-key.pem ubuntu@43.198.12.223 \
    "cd /home/ubuntu/besshow && docker compose -f docker-compose.staging.yml logs bes-rds" > aws-db.log
```

---

**使用建議**: 建議將此文件加入專案文件，並定期更新以反映最新的部署流程和最佳實踐。