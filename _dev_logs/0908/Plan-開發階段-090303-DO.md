# 開發執行紀錄：開發階段-090303

本文件記錄了 `開發階段-090303` 任務的詳細執行步驟、發現與結果。

## 1. 燈種列表顯示

- **目標**: 讓使用者可以在燈種列表頁指定購買數量。
- **分析**:
    - `products.views.ProductOfferingListView` 是正確的視圖。
    - `products/templates/products/product_offering_list.html` 是對應的模板。
    - 模板中已有加入購物車的表單，但缺少數量欄位。
- **操作**:
    - 修改 `product_offering_list.html`，在表單中加入一個 `name="quantity"` 的數字輸入框。
- **結果**: 頁面現在可以讓使用者選擇數量。

## 2. 加入祈福清單 (購物車) 功能

- **目標**: 修改後端邏輯以處理數量，並確保只有登入使用者才能加入購物車。
- **分析**:
    - `cart` 應用使用資料庫儲存購物車，與使用者關聯。
    - `cart.views.add_to_cart` 視圖已存在，但邏輯不完整。
        - 未處理 `quantity` 參數。
        - 未要求使用者登入，但程式碼依賴 `request.user`。
- **操作**:
    - 修改 `cart/views.py` 中的 `add_to_cart` 函式：
        1.  加上 `@login_required` 裝飾器。
        2.  從 `request.POST` 讀取 `quantity`。
        3.  更新邏輯，在建立或更新 `CartItem` 時使用傳入的 `quantity`。
- **結果**: 加入購物車功能現在符合預期，且具備權限控制。

## 3. 祈福清單 (購物車) 詳情頁

- **目標**: 確認購物車詳情頁功能正常。
- **分析**:
    - `cart.views.cart_detail` 視圖和 `cart/templates/cart/detail.html` 模板均已存在。
    - 模板能正確顯示所有項目、數量、價格，並包含一個連結至 `cart:checkout` 的結帳按鈕。
- **操作**: 無需修改。
- **結果**: 購物車詳情頁功能完整。

## 4. 結帳流程串接

- **目標**: 將「結帳」按鈕與「使用者資料確認」流程正確串接。
- **分析**:
    - `cart.views.checkout` 視圖會重導向至使用者資料頁面。
    - 根據 `Check` 階段的發現，重導向時需要附帶 `?next=payment` 參數，才能在資料更新後跳轉至付款頁。
- **操作**:
    - 修改 `cart/views.py` 中的 `checkout` 函式，使用 `reverse` 建立 URL 並附加 `?next=payment` 參數。
- **結果**: 結帳流程已能正確觸發「先完善資料，再付款」的流程。

## 5. 付款頁面

- **目標**: 確認付款頁面已準備就緒。
- **分析**:
    - `orders` 應用中的 `payment_page` 視圖、`payment.html` 模板及對應的 URL `orders:payment_page` 均已存在且功能完整。
    - 頁面能顯示訂單摘要和一個示意 QR Code。
    - 後續的 `create_order` 視圖也已實作。
- **操作**: 無需修改。
- **結果**: 付款與訂單建立流程已準備就緒。

---
**開發任務完成**
